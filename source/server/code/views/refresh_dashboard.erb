<script>
'use strict';
$(() => {

  const $lights = $('#traffic-lights2');
  const $tHeadTr = $('table thead tr', $lights);
  const $tBody = $('table tbody', $lights);

  const id = '<%= @group.id %>';

  cd.refreshDashboard = () => {
    const minuteColumns = cd.minuteColumns.isChecked() ? 'true' : 'false';
    const args = `id=${id}&minute_columns=${minuteColumns}`;
    const url = `/dashboard/heartbeat?${args}`;
    $.getJSON(url, {}, (data) => {
      refreshTableHeadWith(data.time_ticks);
      refreshTableBodyWith(data.avatars);
    });
  };

  const refreshTableHeadWith = (timeTicks) => {
    $tHeadTr.empty();
    if (cd.minuteColumns.isChecked()) {
      $tHeadTr.append($('<tr>')); // to match avatar-image|pie-chart|traffic-light-count
      Object.keys(timeTicks).forEach(function(key) {
        const dhs = timeTicks[key];
        const $th = $('<th>');
        if (Array.isArray(dhs)) {
          $th.append($('<div>', { class:'time-tick' }));
          cd.createTip($th, cd.timeTick(dhs));
        }
        $tHeadTr.append($th);
      }); // forEach
      $tHeadTr.append($('<th>')); // to match scroll-marker
    }
  };

  const refreshTableBodyWith = (avatars) => {
    // for each avatar...
    //   update avatar-image
    //   update pie-chart
    //   update traffic-light-count
    //   update traffic-lights
  };

});
</script>
